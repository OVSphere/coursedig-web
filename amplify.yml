version: 1
applications:
  - appRoot: frontend
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci --include=dev --no-audit --ignore-scripts

        build:
          commands:
            # 1) Create env file from Amplify Console env vars (build-time)
            - rm -f .env.production

            # --- App env (recommended) ---
            - printf "NODE_ENV=%s\n" "${NODE_ENV:-production}" >> .env.production

            # --- DB (required) ---
            - printf "DATABASE_URL=%s\n" "$DATABASE_URL" >> .env.production
            - printf "DATABASE_DIRECT_URL=%s\n" "$DATABASE_DIRECT_URL" >> .env.production

            # --- Core app config ---
            - printf "APP_BASE_URL=%s\n" "$APP_BASE_URL" >> .env.production
            - printf "SESSION_COOKIE_NAME=%s\n" "$SESSION_COOKIE_NAME" >> .env.production
            - printf "SESSION_TTL_DAYS=%s\n" "$SESSION_TTL_DAYS" >> .env.production
            - printf "ADMIN_KEY=%s\n" "$ADMIN_KEY" >> .env.production

            # --- S3 uploads (runtime required for applications/scholarships uploads) ---
            - printf "S3_BUCKET_NAME=%s\n" "$S3_BUCKET_NAME" >> .env.production
            - printf "S3_UPLOAD_PREFIX=%s\n" "$S3_UPLOAD_PREFIX" >> .env.production
            - printf "S3_PUBLIC_BASE_URL=%s\n" "$S3_PUBLIC_BASE_URL" >> .env.production

            # --- Upload limits (if your API validates these) ---
            - printf "APP_MAX_FILES=%s\n" "$APP_MAX_FILES" >> .env.production
            - printf "APP_MAX_PER_FILE_MB=%s\n" "$APP_MAX_PER_FILE_MB" >> .env.production
            - printf "APP_MAX_TOTAL_MB=%s\n" "$APP_MAX_TOTAL_MB" >> .env.production

            # --- AWS region + credentials (ONLY if you are not using an IAM role) ---
            - printf "AWS_REGION=%s\n" "$AWS_REGION" >> .env.production
            - printf "AWS_ACCESS_KEY_ID=%s\n" "$AWS_ACCESS_KEY_ID" >> .env.production
            - printf "AWS_SECRET_ACCESS_KEY=%s\n" "$AWS_SECRET_ACCESS_KEY" >> .env.production

            # --- Email / SMTP (HostGator) ---
            - printf "SMTP_HOST=%s\n" "$SMTP_HOST" >> .env.production
            - printf "SMTP_PORT=%s\n" "$SMTP_PORT" >> .env.production
            - printf "SMTP_USER=%s\n" "$SMTP_USER" >> .env.production
            - printf "SMTP_PASS=%s\n" "$SMTP_PASS" >> .env.production
            - printf "SMTP_SECURE=%s\n" "$SMTP_SECURE" >> .env.production

            # --- App email identities ---
            - printf "SES_FROM_EMAIL=%s\n" "$SES_FROM_EMAIL" >> .env.production
            - printf "SES_ADMIN_EMAIL=%s\n" "$SES_ADMIN_EMAIL" >> .env.production

            # --- Password reset ---
            - printf "RESET_TOKEN_TTL_MINUTES=%s\n" "$RESET_TOKEN_TTL_MINUTES" >> .env.production

            - echo "✅ wrote .env.production" && wc -l .env.production
            # (Optional) quick sanity check (won’t print values)
            - node -e "require('dotenv').config({path:'.env.production'}); const need=['DATABASE_URL','S3_BUCKET_NAME','SMTP_HOST']; const miss=need.filter(k=>!process.env[k]); if(miss.length){console.error('Missing envs:',miss.join(',')); process.exit(1);} console.log('✅ env ok');"

            # 2) Prisma (uses build-time env vars OR .env.production)
            - npx prisma generate
            - npx prisma migrate deploy
            - npx prisma db seed

            # 3) Build Next.js
            - npm run build

        postBuild:
          commands:
            # 4) Copy env file into the SSR compute bundle so runtime can load it
            - mkdir -p .amplify-hosting/compute/default/
            - cp .env.production .amplify-hosting/compute/default/.env.production
            - echo "✅ copied .env.production into compute bundle"
            - ls -la .amplify-hosting/compute/default/ || true

      artifacts:
        baseDirectory: .next
        files:
          - "**/*"

      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
