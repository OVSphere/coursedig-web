generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Enquiry {
  id         String   @id @default(cuid())
  enquiryRef String   @unique
  fullName   String
  email      String
  phone      String?
  message    String
  createdAt  DateTime @default(now())
}

model EnquiryCounter {
  year      Int
  month     Int
  lastValue Int

  @@id([year, month])
}

model User {
  id                      String                           @id @default(cuid())
  email                   String                           @unique
  fullName                String?
  passwordHash            String
  createdAt               DateTime                         @default(now())
  emailVerifiedAt         DateTime?
  isAdmin                 Boolean                          @default(false)
  adminSecondFactorHash   String?
  isSuperAdmin            Boolean                          @default(false)
  updatedAt               DateTime                         @default(now()) @updatedAt
  dateOfBirth             DateTime?
  firstName               String?
  lastName                String?
  phoneNumber             String?
  profileLockedAt         DateTime?
  applications            Application[]
  auditEvents             AuthzAuditEvent[]                @relation("AuditActor")
  resendAttempts          EmailVerificationResendAttempt[]
  emailVerificationTokens EmailVerificationToken[]         @relation("UserEmailVerificationTokens")
  sessions                Session[]
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation("UserEmailVerificationTokens", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Application {
  id                 String                  @id @default(cuid())
  appRef             String                  @unique
  userId             String
  courseName         String
  otherCourseName    String?
  firstName          String
  lastName           String
  dob                DateTime
  email              String
  phone              String
  countryOfResidence String
  personalStatement  String
  courseId           String?
  status             String                  @default("SUBMITTED")
  createdAt          DateTime                @default(now())
  applicationType    ApplicationType         @default(COURSE)
  user               User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  attachments        ApplicationAttachment[]
}

model ApplicationAttachment {
  id            String      @id @default(cuid())
  applicationId String
  fileName      String
  mimeType      String
  sizeBytes     Int
  s3Key         String
  s3Url         String?
  createdAt     DateTime    @default(now())
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

model ApplicationCounter {
  dateKey   String @id
  lastValue Int
}

model Course {
  id                String     @id @default(cuid())
  slug              String     @unique
  title             String
  category          String?
  shortDescription  String?
  overview          String
  whoItsFor         String?
  whatYoullLearn    String?
  entryRequirements String?
  duration          String?
  delivery          String?
  startDatesNote    String?
  priceNote         String?
  published         Boolean    @default(false)
  sortOrder         Int        @default(0)

  // âœ… add these back (used by homepage/admin ranking)
  homePopularRank   Int?
  homeLevel45Rank   Int?
  homeLevel7Rank    Int?

  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  heroImage         String?
  imageAlt          String?
  fee               CourseFee?

  @@index([published])
  @@index([category])
}

model CourseFee {
  id                       String      @id @default(cuid())
  courseId                 String      @unique
  level                    CourseLevel
  amountPence              Int
  currency                 String      @default("GBP")
  payInFullAvailable       Boolean     @default(true)
  payInFullDiscountPercent Int         @default(10)
  note                     String?
  isActive                 Boolean     @default(true)
  createdAt                DateTime    @default(now())
  updatedAt                DateTime    @updatedAt
  course                   Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([level])
  @@index([isActive])
}

model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  fullName  String?
  source    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([createdAt])
}

model AuthzAuditEvent {
  id             String      @id @default(cuid())
  createdAt      DateTime    @default(now())
  action         AuditAction
  actorUserId    String
  targetUserId   String?
  targetCourseId String?
  ipAddress      String?
  userAgent      String?
  before         Json?
  after          Json?
  meta           Json?
  actor          User        @relation("AuditActor", fields: [actorUserId], references: [id])

  @@index([actorUserId])
  @@index([targetUserId])
  @@index([targetCourseId])
  @@index([action])
  @@index([createdAt])
}

model EmailVerificationResendAttempt {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String?
  email     String
  ipAddress String?
  user      User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@index([userId, createdAt])
}

enum ApplicationType {
  COURSE
  SCHOLARSHIP
}

enum CourseLevel {
  VOCATIONAL
  LEVEL3
  LEVEL4_5
  LEVEL7
}

enum AuditAction {
  USER_CREATE
  USER_UPDATE
  USER_DELETE
  USER_PROMOTE_ADMIN
  USER_DEMOTE_ADMIN
  USER_PROMOTE_SUPERADMIN
  USER_DEMOTE_SUPERADMIN
  ADMIN_SECOND_FACTOR_SET
  ADMIN_SECOND_FACTOR_CLEARED
  COURSE_CREATE
  COURSE_UPDATE
  COURSE_DELETE
  COURSE_PUBLISH_TOGGLE
  COURSE_FEE_UPSERT
  USER_EMAIL_VERIFIED_BY_USER
  USER_EMAIL_VERIFIED_BY_ADMIN
  VERIFICATION_EMAIL_RESENT
  SUPERADMIN_SECOND_FACTOR_SET
  SUPERADMIN_SECOND_FACTOR_CLEARED
  USER_IDENTITY_FIELDS_UPDATED_BY_SUPERADMIN
}
