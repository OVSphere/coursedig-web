generator client {
  provider      = "prisma-client"
  output        = "../src/generated/prisma"
  engineType    = "library"
  // Add these for AWS Amplify's environment
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  // ✅ Prisma 7: connection URL is handled in prisma.config.ts (NOT here)
}

model Enquiry {
  id         String   @id @default(cuid())
  enquiryRef String   @unique
  fullName   String
  email      String
  phone      String?
  message    String
  createdAt  DateTime @default(now())
}

model EnquiryCounter {
  year      Int
  month     Int
  lastValue Int

  @@id([year, month])
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  fullName     String?
  passwordHash String
  createdAt    DateTime @default(now())

  // ✅ FIX: your API uses this field, so Prisma must have it
  emailVerifiedAt DateTime?

  sessions     Session[]
  applications Application[]

  emailVerificationTokens EmailVerificationToken[] @relation("UserEmailVerificationTokens")
}

model EmailVerificationToken {
  id String @id @default(cuid())

  userId String
  // ✅ FIX: single-line @relation (no multiline parentheses)
  user   User   @relation("UserEmailVerificationTokens", fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

enum ApplicationType {
  COURSE
  SCHOLARSHIP
}

model Application {
  id     String @id @default(cuid())
  appRef String @unique

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  applicationType ApplicationType @default(COURSE)

  courseName      String
  otherCourseName String?

  firstName String
  lastName  String
  dob       DateTime

  email              String
  phone              String
  countryOfResidence String
  personalStatement  String

  courseId String?

  status    String   @default("SUBMITTED")
  createdAt DateTime @default(now())

  attachments ApplicationAttachment[]
}

model ApplicationAttachment {
  id            String      @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  fileName  String
  mimeType  String
  sizeBytes Int
  s3Key     String
  s3Url     String?
  createdAt DateTime @default(now())

  @@index([applicationId])
}

model ApplicationCounter {
  dateKey   String @id
  lastValue Int
}

model Course {
  id               String @id @default(cuid())
  slug             String @unique
  title            String
  category         String
  shortDescription String
  overview         String

  whoItsFor         String?
  whatYoullLearn    String?
  entryRequirements String?
  duration          String?
  delivery          String?
  startDatesNote    String?
  priceNote         String?

  heroImage String?
  imageAlt  String?

  // ✅ add this
  fee CourseFee?

  published Boolean @default(false)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([published])
  @@index([category])
}

enum CourseLevel {
  VOCATIONAL
  LEVEL3
  LEVEL4_5
  LEVEL7
}

model CourseFee {
  id String @id @default(cuid())

  courseId String @unique
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  level CourseLevel

  amountPence Int
  currency    String @default("GBP")

  payInFullAvailable       Boolean @default(true)
  payInFullDiscountPercent Int     @default(10)

  note     String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([level])
  @@index([isActive])
}
